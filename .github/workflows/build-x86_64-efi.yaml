name: 编译ImmortalWrt x86_64 EFI固件（24.10.4版本）
on:
  workflow_dispatch:
jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    env:
      OVERLAY_SIZE: 3072M
      TARGET_ARCH: x86/64
      TAG_VERSION: 24.10.4
      REPO_URL: https://github.com/immortalwrt/immortalwrt
    steps:
      - name: 系统初始化 & 修复源配置
        run: |
          # 启用i386架构
          sudo dpkg --add-architecture i386
          # 写入Ubuntu官方源（root权限，修复Permission denied）
          sudo tee /etc/apt/sources.list > /dev/null <<EOF
deb http://archive.ubuntu.com/ubuntu/ jammy main universe multiverse restricted
deb http://archive.ubuntu.com/ubuntu/ jammy-updates main universe multiverse restricted
deb http://archive.ubuntu.com/ubuntu/ jammy-security main universe multiverse restricted
EOF
          # 更新源 + 清理冗余文件
          sudo apt update -y -qq
          sudo DEBIAN_FRONTEND=noninteractive apt purge -y -qq dotnet* ghc* android* firefox llvm* powershell mono-devel snapd flatpak
          sudo DEBIAN_FRONTEND=noninteractive apt autoremove -y -qq --purge
          sudo apt clean -y -qq
          sudo rm -rf /var/lib/apt/lists/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /var/lib/docker /tmp/* ~/.cache/*
          # 处理swapfile占用
          if swapon --show | grep -q "/swapfile"; then
            sudo swapoff /swapfile && sudo rm -f /swapfile
          fi
          sudo dd if=/dev/zero of=/swapfile bs=1G count=8 status=progress
          sudo chmod 600 /swapfile && sudo mkswap /swapfile && sudo swapon /swapfile
          sudo sysctl vm.swappiness=10
      - name: 拉取ImmortalWrt 24.10.4 Tag源码
        run: |
          CLONE_SUCCESS=0
          for i in {1..3}; do
            echo "===== 第 $i 次尝试克隆仓库 ====="
            rm -rf immortalwrt
            git clone ${{ env.REPO_URL }} immortalwrt && CLONE_SUCCESS=1 && break
            echo "❌ 第 $i 次克隆失败，10秒后重试..."
            sleep 10
          done
          if [ $CLONE_SUCCESS -ne 1 ]; then
            echo "❌ 3次克隆仓库均失败，退出编译"
            exit 1
          fi
          cd immortalwrt
          echo "===== 检查${{ env.TAG_VERSION }} Tag是否存在 ====="
          if ! git tag | grep -q "^${{ env.TAG_VERSION }}$"; then
            export TAG_VERSION="v${{ env.TAG_VERSION }}"
            if ! git tag | grep -q "^${TAG_VERSION}$"; then
              echo "❌ 未找到${{ env.TAG_VERSION }}/v${{ env.TAG_VERSION }} Tag"
              exit 1
            fi
          fi
          git checkout ${TAG_VERSION}
          git reset --hard ${TAG_VERSION}
          echo "===== 当前版本：$(git describe --tags) ====="
      - name: 安装核心编译依赖
        run: |
          cd immortalwrt
          sudo apt update -y -qq
          sudo DEBIAN_FRONTEND=noninteractive apt install -y -qq build-essential flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget curl
      - name: 加载自定义配置
        run: |
          cd immortalwrt
          cp ../config.seed .config
          echo "CONFIG_TARGET_IMAGES_PARTITION_OVERLAY_SIZE=\"${{ env.OVERLAY_SIZE }}\"" >> .config
          echo "CONFIG_TARGET_ROOTFS_PARTSIZE=3072" >> .config
          make defconfig
          ./scripts/feeds update -a && ./scripts/feeds install -a
          sed -i 's/downloads.openwrt.org/mirrors.ustc.edu.cn\/openwrt/g' ./feeds.conf.default
      - name: 下载编译依赖
        run: |
          cd immortalwrt
          for i in {1..3}; do
            echo "===== 第 $i 次下载依赖 ====="
            make download -j$(nproc) && break
            if [ $i -eq 3 ]; then exit 1; fi
            sleep 5
          done
          find dl -size -1024c -exec rm -f {} \;
      - name: 编译固件
        run: |
          cd immortalwrt
          CORES=$(nproc)
          COMPILE_CORES=$([ $CORES -gt 4 ] && echo $((CORES-1)) || echo $CORES)
          make -j$COMPILE_CORES || make -j1 V=s
          ls -lh bin/targets/${{ env.TARGET_ARCH }}/
      - name: 上传固件产物
        uses: actions/upload-artifact@v4
        with:
          name: ImmortalWrt-x86_64-${{ env.TAG_VERSION }}-EFI-BIOS-${{ github.run_id }}
          path: |
            immortalwrt/bin/targets/${{ env.TARGET_ARCH }}/*-efi.img.gz
            immortalwrt/bin/targets/${{ env.TARGET_ARCH }}/*.img.gz
            immortalwrt/bin/targets/${{ env.TARGET_ARCH }}/*.iso
          retention-days: 7
      - name: 清理临时文件
        if: always()
        run: |
          if swapon --show | grep -q "/swapfile"; then
            sudo swapoff /swapfile && sudo rm -f /swapfile
          fi
