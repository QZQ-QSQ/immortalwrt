name: Build Custom Firmware
on:
  workflow_dispatch:  # 这行是启用手动触发按钮的关键
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/build.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ImmortalWrt Source
        uses: actions/checkout@v4
        with:
          repository: immortalwrt/immortalwrt
          submodules: recursive

      - name: Download Custom Config
        run: |
          wget -O .config https://raw.githubusercontent.com/YOUR_GITHUB_USERNAME/immortalwrt-custom/main/.config
          wget -O diy-part2.sh https://raw.githubusercontent.com/YOUR_GITHUB_USERNAME/immortalwrt-custom/main/diy-part2.sh
          chmod +x diy-part2.sh
        # 切记替换 YOUR_GITHUB_USERNAME 为你的用户名！

      - name: Update Feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Apply Custom Script
        run: bash diy-part2.sh

      - name: Build Firmware
        run: |
          make defconfig
          make download -j$(nproc)
          make -j$(($(nproc)+1)) || make -j1 V=s

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-firmware
          path: bin/targets/x86/64/
