name: Build Custom ImmortalWrt

# 触发条件
on:
  # 关键：启用手动触发按钮
  workflow_dispatch:
    inputs:
      description:
        description: '编译描述 (可选)'
        required: false
        default: '手动触发编译'
  # 当配置文件更新时自动触发（在你的个人配置仓库）
  repository_dispatch:
    types: [config_update]
  # 推送工作流文件自身时也触发（用于调试）
  push:
    paths:
      - '.github/workflows/build.yml'

# 环境变量
env:
  # 基础设置
  FEEDS_CONF: feeds.conf.default
  # 你的自定义配置仓库（替换YOUR_USERNAME）
  CONFIG_REPO: "https://github.com/YOUR_GITHUB_USERNAME/immortalwrt-custom"
  # 编译线程数（根据GitHub Actions机器配置优化）
  MAKE_JOBS: ${{ fromJSON(vars.MAKE_JOBS || '19') }}

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180  # 3小时超时，防止卡死

    steps:
    # 1. 检出ImmortalWrt源码（使用官方源，保持最新）
    - name: Checkout ImmortalWrt source
      uses: actions/checkout@v4
      with:
        repository: immortalwrt/immortalwrt
        ref: v24.10.4
        submodules: recursive
        path: openwrt

    # 2. 下载你的自定义配置
    - name: Download custom configuration
      run: |
        cd openwrt
        # 下载.config主配置文件
        wget -q -O .config "${{ env.CONFIG_REPO }}/raw/main/.config"
        # 下载自定义脚本
        wget -q -O diy-part2.sh "${{ env.CONFIG_REPO }}/raw/main/diy-part2.sh"
        chmod +x diy-part2.sh
        
        # 验证配置文件是否存在
        if [ ! -f ".config" ]; then
          echo "错误: .config 文件下载失败"
          exit 1
        fi
        
        echo "✅ 自定义配置下载完成"

    # 3. 安装编译依赖（Ubuntu系统）
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          clang \
          flex \
          bison \
          g++ \
          gawk \
          gcc-multilib \
          gettext \
          git \
          libncurses5-dev \
          libssl-dev \
          python3 \
          python3-distutils \
          rsync \
          unzip \
          zlib1g-dev \
          file \
          wget
        echo "✅ 系统依赖安装完成"

    # 4. 更新软件源
    - name: Update feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "✅ Feeds更新完成"

    # 5. 执行自定义脚本（调整overlay大小等）
    - name: Run customization script
      run: |
        cd openwrt
        ./diy-part2.sh
        echo "✅ 自定义脚本执行完成"

    # 6. 准备编译环境
    - name: Prepare build environment
      run: |
        cd openwrt
        # 应用最终配置
        make defconfig
        # 检查关键配置
        echo "=== 检查关键配置 ==="
        grep -E "(TARGET_ROOTFS_PARTSIZE|CONFIG_TARGET_x86_64|CONFIG_CCACHE)" .config || true
        echo "=================="
        
        # 创建编译缓存目录（避免空间不足的关键）
        mkdir -p ../dl ../ccache
        ln -sf ../dl
        ln -sf ../ccache
        echo "✅ 编译环境准备完成"

    # 7. 下载所有软件包（关键步骤，避免编译中途失败）
    - name: Download packages
      run: |
        cd openwrt
        # 并行下载，但限制并发数
        make download -j8
        # 检查下载完整性
        make -j1 V=s download 2>&1 | grep -E "(failed|error)" || true
        echo "✅ 软件包下载完成"

    # 8. 开始编译（分两步，提高稳定性）
    - name: Compile firmware (step 1)
      run: |
        cd openwrt
        # 第一次编译，使用多线程
        echo "开始第一阶段编译 (使用${{ env.MAKE_JOBS }}线程)..."
        make -j${{ env.MAKE_JOBS }} || echo "第一阶段编译可能有警告，继续..."
        echo "✅ 第一阶段编译完成"

    - name: Compile firmware (step 2)
      run: |
        cd openwrt
        # 第二次编译，单线程确保完成
        echo "开始最终编译 (单线程确保稳定性)..."
        make -j1 V=s 2>&1 | tail -50
        echo "✅ 编译完成！"

    # 9. 上传固件成品
    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: immortalwrt-firmware-x86_64
        path: |
          openwrt/bin/targets/x86/64/*.img.gz
          openwrt/bin/targets/x86/64/*.img
          openwrt/bin/targets/x86/64/*.manifest
        retention-days: 7
        compression-level: 0  # 固件已压缩，无需再压缩

    # 10. 编译失败时的处理
    - name: Handle failure
      if: failure()
      run: |
        echo "编译失败！请检查以下可能原因："
        echo "1. 网络问题导致包下载失败"
        echo "2. 自定义配置有语法错误"
        echo "3. 云编译空间不足"
        echo ""
        echo "建议："
        echo "- 重新运行此工作流"
        echo "- 检查.config文件格式"
        echo "- 精简不必要的软件包"
        
        # 保存错误日志（如果需要调试）
        if [ -f "openwrt/build.log" ]; then
          tail -100 openwrt/build.log
        fi
