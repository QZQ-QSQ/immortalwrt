name: Build ImmortalWrt Firmware

on:
  workflow_dispatch:
    inputs:
      # 基础编译参数
      version:
        description: 'ImmortalWrt 源码分支/版本'
        required: true
        default: 'master'
        type: string
      target_platform:
        description: '目标平台（如 x86_64、ramips/mt7621 等）'
        required: true
        default: 'x86_64'
        type: string
      
      # Overlay 自定义
      customize_overlay:
        description: '自定义Overlay大小'
        required: true
        default: 'false'
        type: boolean
      rootfs_size:
        description: 'RootFS分区大小 (MB)'
        required: false
        default: '1024'
        type: string
      overlay_size:
        description: 'Overlay分区大小 (MB)'
        required: false
        default: '2048'
        type: string
      overlay_type:
        description: 'Overlay文件系统类型'
        required: false
        default: 'ext4'
        type: choice
        options:
          - f2fs
          - ext4
          - squashfs
      expand_kernel:
        description: '扩展Kernel分区'
        required: false
        default: 'false'
        type: boolean
      kernel_size:
        description: 'Kernel分区大小 (MB)'
        required: false
        default: '256'
        type: string
      
      # 科学上网插件
      enable_passwall:
        description: 'PassWall'
        required: true
        default: 'false'
        type: boolean
      enable_passwall2:
        description: 'PassWall2'
        required: true
        default: 'false'
        type: boolean
      enable_openclash:
        description: 'OpenClash'
        required: true
        default: 'false'
        type: boolean
      enable_ssr_plus:
        description: 'SSR Plus+'
        required: true
        default: 'false'
        type: boolean
      enable_bypass:
        description: 'Bypass'
        required: true
        default: 'false'
        type: boolean
      enable_v2ray:
        description: 'V2Ray Core'
        required: true
        default: 'false'
        type: boolean
      enable_xray:
        description: 'Xray Core'
        required: true
        default: 'false'
        type: boolean
      enable_hysteria:
        description: 'Hysteria'
        required: true
        default: 'false'
        type: boolean
      enable_tuic:
        description: 'TUIC Client'
        required: true
        default: 'false'
        type: boolean
      enable_naiveproxy:
        description: 'NaiveProxy'
        required: true
        default: 'false'
        type: boolean
      
      # 网络加速
      enable_sfe:
        description: 'SFE 流控'
        required: true
        default: 'false'
        type: boolean
      enable_shortcut_fe:
        description: 'Shortcut FE'
        required: true
        default: 'false'
        type: boolean
      enable_fullcone:
        description: 'FullCone NAT'
        required: true
        default: 'false'
        type: boolean
      enable_bbr:
        description: 'BBR 拥塞控制'
        required: true
        default: 'false'
        type: boolean
      enable_turboacc:
        description: 'Turbo ACC 加速'
        required: true
        default: 'false'
        type: boolean
      
      # 存储管理
      enable_diskman:
        description: 'DiskMan 磁盘管理'
        required: true
        default: 'false'
        type: boolean
      enable_dockerman:
        description: 'DockerMan'
        required: true
        default: 'false'
        type: boolean
      enable_filebrowser:
        description: 'FileBrowser 文件管理'
        required: true
        default: 'false'
        type: boolean
      enable_qbittorrent:
        description: 'qBittorrent 下载'
        required: true
        default: 'false'
        type: boolean
      enable_transmission:
        description: 'Transmission 下载'
        required: true
        default: 'false'
        type: boolean
      enable_aria2:
        description: 'Aria2 下载'
        required: true
        default: 'false'
        type: boolean
      
      # 文件共享
      enable_samba4:
        description: 'Samba4 共享'
        required: true
        default: 'false'
        type: boolean
      enable_nfs:
        description: 'NFS 共享'
        required: true
        default: 'false'
        type: boolean
      enable_ftp:
        description: 'FTP 服务'
        required: true
        default: 'false'
        type: boolean
      enable_webdav:
        description: 'WebDAV 服务'
        required: true
        default: 'false'
        type: boolean
      
      # 广告过滤
      enable_adguardhome:
        description: 'AdGuardHome'
        required: true
        default: 'false'
        type: boolean
      enable_adblock:
        description: 'AdBlock'
        required: true
        default: 'false'
        type: boolean
      
      # 网络工具
      enable_ddns:
        description: 'DDNS 动态域名'
        required: true
        default: 'false'
        type: boolean
      enable_upnp:
        description: 'UPnP 端口映射'
        required: true
        default: 'false'
        type: boolean
      enable_arpbind:
        description: 'ARP 绑定'
        required: true
        default: 'false'
        type: boolean
      enable_wol:
        description: 'WOL 网络唤醒'
        required: true
        default: 'false'
        type: boolean
      enable_nlbwmon:
        description: 'NLBWMON 流量监控'
        required: true
        default: 'false'
        type: boolean
      enable_vlmcsd:
        description: 'VLMC SD KMS激活'
        required: true
        default: 'false'
        type: boolean
      enable_wireguard:
        description: 'WireGuard 虚拟网卡'
        required: true
        default: 'false'
        type: boolean
      enable_openvpn:
        description: 'OpenVPN'
        required: true
        default: 'false'
        type: boolean
      enable_zerotier:
        description: 'ZeroTier 组网'
        required: true
        default: 'false'
        type: boolean
      enable_frpc:
        description: 'FRPC 内网穿透'
        required: true
        default: 'false'
        type: boolean
      enable_frps:
        description: 'FRPS 内网穿透服务端'
        required: true
        default: 'false'
        type: boolean
      
      # 系统工具
      enable_autoreboot:
        description: 'AutoReboot 自动重启'
        required: true
        default: 'false'
        type: boolean
      enable_ttyd:
        description: 'TTYD 网页终端'
        required: true
        default: 'false'
        type: boolean
      enable_cpufreq:
        description: 'CPUFreq 调频'
        required: true
        default: 'false'
        type: boolean
      enable_irqbalance:
        description: 'IRQBalance 中断均衡'
        required: true
        default: 'false'
        type: boolean
      enable_sqm:
        description: 'SQM 流量整形'
        required: true
        default: 'false'
        type: boolean
      enable_netdata:
        description: 'NetData 监控'
        required: true
        default: 'false'
        type: boolean
      
      # 主题
      enable_argon_theme:
        description: 'Argon主题'
        required: true
        default: 'true'
        type: boolean
      enable_design_theme:
        description: 'Design主题'
        required: true
        default: 'false'
        type: boolean
      enable_bootstrap_theme:
        description: 'Bootstrap主题'
        required: true
        default: 'false'
        type: boolean
      enable_edge_theme:
        description: 'Edge主题'
        required: true
        default: 'false'
        type: boolean
      
      # 网络协议
      enable_ipv6:
        description: 'IPv6支持'
        required: true
        default: 'true'
        type: boolean
      enable_multipath:
        description: '多线多拨'
        required: true
        default: 'false'
        type: boolean
      enable_mwan3:
        description: 'MWAN3 负载均衡'
        required: true
        default: 'false'
        type: boolean
      enable_syncdial:
        description: 'SyncDial 多拨同步'
        required: true
        default: 'false'
        type: boolean
      
      # USB功能
      enable_usb_printer:
        description: 'USB打印机'
        required: true
        default: 'false'
        type: boolean
      enable_usb_4g:
        description: 'USB 4G/5G网卡'
        required: true
        default: 'false'
        type: boolean
      enable_usb_audio:
        description: 'USB音频'
        required: true
        default: 'false'
        type: boolean
      enable_usb_serial:
        description: 'USB串口'
        required: true
        default: 'false'
        type: boolean
      
      # 个性化
      default_ip:
        description: '默认IP地址'
        required: true
        default: '192.168.1.1'
        type: string
      default_password:
        description: '默认密码 (留空为password)'
        required: false
        default: ''
        type: string
      hostname:
        description: '主机名'
        required: false
        default: 'ImmortalWrt'
        type: string
      timezone:
        description: '时区'
        required: true
        default: 'Asia/Shanghai'
        type: choice
        options:
          - Asia/Shanghai
          - Asia/Hong_Kong
          - Asia/Taipei
          - Asia/Tokyo
          - Asia/Singapore
          - America/New_York
          - Europe/London
      
      # 额外软件源
      add_kenzok8:
        description: '添加kenzok8软件源'
        required: true
        default: 'true'
        type: boolean
      add_lienol:
        description: '添加Lienol软件源'
        required: true
        default: 'false'
        type: boolean
      add_immortalwrt_packages:
        description: '添加ImmortalWrt官方软件源'
        required: true
        default: 'true'
        type: boolean

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id
    
    steps:
    - name: 检查代码
      uses: actions/checkout@main
    
    - name: 初始化编译环境
      run: |
        sudo -E apt update
        sudo -E apt install -y build-essential asciidoc binutils bzip2 gawk gettext git libncurses5-dev libz-dev patch python3 python2.7 unzip zlib1g-dev lib32gcc-s1 libc6-dev-i386 subversion flex uglifyjs git-core gcc-multilib p7zip p7zip-full msmtp libssl-dev texinfo libglib2.0-dev xmlto qemu-utils upx libelf-dev autoconf automake libtool autopoint device-tree-compiler g++-multilib antlr3 gperf wget curl swig rsync
        sudo -E systemctl daemon-reload
        sudo -E timedatectl set-timezone "${{ github.event.inputs.timezone || 'Asia/Shanghai' }}"
        
    - name: 克隆源码
      run: |
        git clone --depth 1 https://github.com/immortalwrt/immortalwrt -b ${{ github.event.inputs.version }} openwrt
        cd openwrt
        
        if [ "${{ github.event.inputs.add_kenzok8 }}" == "true" ]; then
          echo "src-git kenzo https://github.com/kenzok8/openwrt-packages" >> feeds.conf.default
          echo "src-git small https://github.com/kenzok8/small" >> feeds.conf.default
        fi
        
        if [ "${{ github.event.inputs.add_lienol }}" == "true" ]; then
          echo "src-git lienol https://github.com/Lienol/openwrt-package" >> feeds.conf.default
        fi
        
        if [ "${{ github.event.inputs.add_immortalwrt_packages }}" == "true" ]; then
          echo "src-git immortalwrt https://github.com/immortalwrt/packages.git" >> feeds.conf.default
          echo "src-git luci https://github.com/immortalwrt/luci.git" >> feeds.conf.default
        fi
        
    - name: 更新feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
    - name: 生成配置
      run: |
        cd openwrt
        
        # 基础平台配置
        echo "CONFIG_TARGET_${{ github.event.inputs.target_platform }}=y" >> .config
        
        # Overlay大小设置
        if [ "${{ github.event.inputs.customize_overlay }}" == "true" ]; then
          echo "CONFIG_TARGET_ROOTFS_PARTSIZE=${{ github.event.inputs.rootfs_size }}" >> .config
          
          if [[ "${{ github.event.inputs.target_platform }}" == x86_64 ]]; then
            case "${{ github.event.inputs.overlay_type }}" in
              f2fs)
                echo "CONFIG_TARGET_ROOTFS_F2FS=y" >> .config
                sed -i "s/CONFIG_TARGET_ROOTFS_PARTSIZE=.*/CONFIG_TARGET_ROOTFS_PARTSIZE=${{ github.event.inputs.rootfs_size }}/g" target/linux/x86/image/Makefile
                echo "CONFIG_TARGET_ROOTFS_OVERLAY_SIZE=${{ github.event.inputs.overlay_size }}" >> .config
                ;;
              ext4)
                echo "CONFIG_TARGET_ROOTFS_EXT4FS=y" >> .config
                sed -i "s/CONFIG_TARGET_ROOTFS_PARTSIZE=.*/CONFIG_TARGET_ROOTFS_PARTSIZE=${{ github.event.inputs.rootfs_size }}/g" target/linux/x86/image/Makefile
                echo "CONFIG_TARGET_ROOTFS_OVERLAY_SIZE=${{ github.event.inputs.overlay_size }}" >> .config
                ;;
              squashfs)
                echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
                ;;
            esac
            
            if [ "${{ github.event.inputs.expand_kernel }}" == "true" ]; then
              echo "CONFIG_TARGET_KERNEL_PARTSIZE=${{ github.event.inputs.kernel_size }}" >> .config
            fi
          else
            echo "注意：非x86平台Overlay大小可能无法直接自定义，将使用默认布局。"
          fi
        fi
        
        # 基础LuCI
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-ssl=y" >> .config
        echo "CONFIG_PACKAGE_luci-compat=y" >> .config
        
        # 科学上网类
        if [ "${{ github.event.inputs.enable_passwall }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-passwall=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-passwall_Iptables_Transparent_Proxy=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_passwall2 }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-passwall2=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-passwall2_Iptables_Transparent_Proxy=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_openclash }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-openclash=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_ssr_plus }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-ssr-plus=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_V2ray=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Xray=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks_Rust_Client=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_bypass }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-bypass=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_v2ray }}" == "true" ]; then
          echo "CONFIG_PACKAGE_v2ray-core=y" >> .config
          echo "CONFIG_PACKAGE_v2ray-plugin=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_xray }}" == "true" ]; then
          echo "CONFIG_PACKAGE_xray-core=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_hysteria }}" == "true" ]; then
          echo "CONFIG_PACKAGE_hysteria=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_tuic }}" == "true" ]; then
          echo "CONFIG_PACKAGE_tuic-client=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_naiveproxy }}" == "true" ]; then
          echo "CONFIG_PACKAGE_naiveproxy=y" >> .config
        fi
        
        # 网络加速
        if [ "${{ github.event.inputs.enable_sfe }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-flowoffload=y" >> .config
          echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_shortcut_fe }}" == "true" ]; then
          echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_fullcone }}" == "true" ]; then
          echo "CONFIG_PACKAGE_kmod-ipt-fullconenat=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_bbr }}" == "true" ]; then
          echo "CONFIG_PACKAGE_kmod-tcp-bbr=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_turboacc }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
          echo "CONFIG_PACKAGE_turboacc=y" >> .config
        fi
        
        # 存储管理
        if [ "${{ github.event.inputs.enable_diskman }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-diskman=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-diskman_INCLUDE_badblocks=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-diskman_INCLUDE_mdadm=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_dockerman }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-dockerman=y" >> .config
          echo "CONFIG_PACKAGE_docker-ce=y" >> .config
          echo "CONFIG_PACKAGE_docker-compose=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_filebrowser }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-filebrowser=y" >> .config
          echo "CONFIG_PACKAGE_filebrowser=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_qbittorrent }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-qbittorrent=y" >> .config
          echo "CONFIG_PACKAGE_qbittorrent=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_transmission }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-transmission=y" >> .config
          echo "CONFIG_PACKAGE_transmission-web-control=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_aria2 }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-aria2=y" >> .config
          echo "CONFIG_PACKAGE_aria2=y" >> .config
        fi
        
        # 文件共享
        if [ "${{ github.event.inputs.enable_samba4 }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-samba4=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_nfs }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-nfs=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_ftp }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-vsftpd=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_webdav }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-webdav=y" >> .config
        fi
        
        # 广告过滤
        if [ "${{ github.event.inputs.enable_adguardhome }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-adguardhome=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_adblock }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-adblock=y" >> .config
        fi
        
        # 网络工具
        if [ "${{ github.event.inputs.enable_ddns }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-ddns=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_upnp }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-upnp=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_arpbind }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-arpbind=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_wol }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-wol=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_nlbwmon }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-nlbwmon=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_vlmcsd }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-vlmcsd=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_wireguard }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-wireguard=y" >> .config
          echo "CONFIG_PACKAGE_kmod-wireguard=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_openvpn }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-openvpn=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_zerotier }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-zerotier=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_frpc }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-frpc=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_frps }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-frps=y" >> .config
        fi
        
        # 系统工具
        if [ "${{ github.event.inputs.enable_autoreboot }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-autoreboot=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_ttyd }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-ttyd=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_cpufreq }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-cpufreq=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_irqbalance }}" == "true" ]; then
          echo "CONFIG_PACKAGE_irqbalance=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_sqm }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-sqm=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_netdata }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-netdata=y" >> .config
        fi
        
        # 主题
        if [ "${{ github.event.inputs.enable_argon_theme }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-theme-argon=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_design_theme }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-theme-design=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_bootstrap_theme }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-theme-bootstrap=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_edge_theme }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-theme-edge=y" >> .config
        fi
        
        # 网络协议
        if [ "${{ github.event.inputs.enable_ipv6 }}" == "true" ]; then
          echo "CONFIG_PACKAGE_ipv6helper=y" >> .config
          echo "CONFIG_PACKAGE_odhcp6c=y" >> .config
          echo "CONFIG_PACKAGE_odhcpd-ipv6only=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_multipath }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-syncdial=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_mwan3 }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-mwan3=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_syncdial }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-syncdial=y" >> .config
        fi
        
        # USB功能
        if [ "${{ github.event.inputs.enable_usb_printer }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-usb-printer=y" >> .config
          echo "CONFIG_PACKAGE_kmod-usb-printer=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_usb_4g }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-modem=y" >> .config
          echo "CONFIG_PACKAGE_kmod-usb-serial=y" >> .config
          echo "CONFIG_PACKAGE_kmod-usb-serial-option=y" >> .config
          echo "CONFIG_PACKAGE_kmod-usb-serial-wwan=y" >> .config
          echo "CONFIG_PACKAGE_comgt=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_usb_audio }}" == "true" ]; then
          echo "CONFIG_PACKAGE_kmod-usb-audio=y" >> .config
          echo "CONFIG_PACKAGE_alsa-utils=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_usb_serial }}" == "true" ]; then
          echo "CONFIG_PACKAGE_kmod-usb-serial=y" >> .config
          echo "CONFIG_PACKAGE_kmod-usb-serial-ch341=y" >> .config
          echo "CONFIG_PACKAGE_kmod-usb-serial-cp210x=y" >> .config
          echo "CONFIG_PACKAGE_kmod-usb-serial-pl2303=y" >> .config
        fi
        
        # 基础工具
        echo "CONFIG_PACKAGE_iperf3=y" >> .config
        echo "CONFIG_PACKAGE_htop=y" >> .config
        echo "CONFIG_PACKAGE_nano=y" >> .config
        echo "CONFIG_PACKAGE_curl=y" >> .config
        echo "CONFIG_PACKAGE_wget=y" >> .config
        echo "CONFIG_PACKAGE_tcpdump=y" >> .config
        echo "CONFIG_PACKAGE_openssh-sftp-server=y" >> .config
        echo "CONFIG_PACKAGE_screen=y" >> .config
        echo "CONFIG_PACKAGE_tree=y" >> .config
        echo "CONFIG_PACKAGE_git=y" >> .config
        echo "CONFIG_PACKAGE_unzip=y" >> .config
        echo "CONFIG_PACKAGE_tar=y" >> .config
        
        # 生成完整配置
        make defconfig
        
    - name: 个性化设置
      run: |
        cd openwrt
        
        sed -i 's/192.168.1.1/${{ github.event.inputs.default_ip }}/g' package/base-files/files/bin/config_generate
        
        if [ -n "${{ github.event.inputs.hostname }}" ]; then
          sed -i "s/hostname='OpenWrt'/hostname='${{ github.event.inputs.hostname }}'/g" package/base-files/files/bin/config_generate
        fi
        
        if [ -n "${{ github.event.inputs.default_password }}" ]; then
          PWD_HASH=$(openssl passwd -1 "${{ github.event.inputs.default_password }}")
          sed -i "s|root::0:0:99999:7:::|root:${PWD_HASH}:0:0:99999:7:::|g" package/base-files/files/etc/shadow
        fi
        
        sed -i "s/timezone='UTC'/timezone='${{ github.event.inputs.timezone }}'/g" package/base-files/files/bin/config_generate
        
        mkdir -p files/etc/uci-defaults
        cat > files/etc/uci-defaults/99-custom << EOF
#!/bin/sh
uci set system.@system[0].zonename='${{ github.event.inputs.timezone }}'
uci set system.@system[0].timezone='CST-8'
uci commit system
EOF
        chmod +x files/etc/uci-defaults/99-custom
    
    - name: 开始编译
      run: |
        cd openwrt
        make -j$(nproc) download V=s
        make -j$(nproc) V=s || make -j1 V=s
    
    - name: 上传编译产物
      uses: actions/upload-artifact@main
      with:
        name: ImmortalWrt-Firmware-${{ github.event.inputs.target_platform }}
        path: openwrt/bin/targets/**/*.bin
