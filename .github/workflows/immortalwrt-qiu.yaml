name: Build ImmortalWrt固件

on:
  workflow_dispatch:
    inputs:
      # 基础配置
      # ===== 请将配置中 on.workflow_dispatch.inputs.version 部分 替换为以下代码 =====
      version:
        description: '选择ImmortalWrt版本 (最新推荐: 24.10-SNAPSHOT 或 main)'
        required: true
        default: 'main'
        type: choice
        options:
          - 'main'                       # 滚动更新版，内核和软件包最新，功能最多，但可能存在小问题[citation:2]
          - 'v24.10-SNAPSHOT'            # 下一个稳定版的快照，介于稳定和最新之间，比较推荐[citation:1]
          - 'openwrt-24.10'               # 2024年10月后的稳定版，支持周期长
          - 'openwrt-23.05'               # 长期维护的旧稳定版，最保险[citation:4]
          - 'openwrt-21.02'               # 更旧的版本
      
      target_platform:
        description: '选择目标平台'
        required: true
        default: 'x86_64'
        type: choice
        options:
          - x86_64
          - rockchip-armv8
          - rockchip-armv8/r5c
          - rockchip-armv8/r4s
          - rockchip-armv8/r4s-enterprise
          - rockchip-armv8/r2s
          - rockchip-armv8/r2c
          - ipq807x/generic
          - mediatek/mt7986
          - bcm27xx/bcm2711
          - bcm27xx/bcm2712
          - ramips/mt7621
      
      rootfs_size:
        description: '根文件系统大小(MB)'
        required: true
        default: '1024'
        type: choice
        options:
          - '512'
          - '1024'
          - '2048'
          - '4096'
          - '8192'
      
      # Overlay自定义
      customize_overlay:
        description: '是否自定义Overlay大小 (仅x86有效)'
        required: true
        default: 'true'
        type: boolean
      
      overlay_size:
        description: 'Overlay大小(MB) - 安装软件的空间'
        required: true
        default: '512'
        type: choice
        options:
          - '256'
          - '512'
          - '1024'
          - '2048'
          - '4096'
          - '8192'
      
      overlay_type:
        description: 'Overlay类型 (x86)'
        required: true
        default: 'f2fs'
        type: choice
        options:
          - f2fs
          - ext4
          - squashfs
      
      expand_kernel:
        description: '扩展内核分区 (x86)'
        required: true
        default: 'false'
        type: boolean
      
      kernel_size:
        description: '内核分区大小(MB) (x86)'
        required: true
        default: '64'
        type: choice
        options:
          - '32'
          - '64'
          - '128'
          - '256'
      
      clean_build:
        description: '是否清理编译环境'
        required: true
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      
      # ========== 科学上网类 ==========
      enable_passwall:
        description: 'PassWall (代理工具)'
        required: true
        default: 'true'
        type: boolean
      
      enable_passwall2:
        description: 'PassWall2 (代理工具2)'
        required: true
        default: 'false'
        type: boolean
      
      enable_openclash:
        description: 'OpenClash (Clash客户端)'
        required: true
        default: 'true'
        type: boolean
      
      enable_ssr_plus:
        description: 'SSR Plus+ (代理工具)'
        required: true
        default: 'false'
        type: boolean
      
      enable_bypass:
        description: 'Bypass (代理工具)'
        required: true
        default: 'false'
        type: boolean
      
      enable_v2ray:
        description: 'V2ray (代理核心)'
        required: true
        default: 'true'
        type: boolean
      
      enable_xray:
        description: 'Xray (代理核心)'
        required: true
        default: 'true'
        type: boolean
      
      enable_hysteria:
        description: 'Hysteria (代理协议)'
        required: true
        default: 'false'
        type: boolean
      
      enable_tuic:
        description: 'Tuic (代理协议)'
        required: true
        default: 'false'
        type: boolean
      
      enable_naiveproxy:
        description: 'NaiveProxy (代理协议)'
        required: true
        default: 'false'
        type: boolean
      
      # ========== 网络加速类 ==========
      enable_sfe:
        description: 'SFE (快速转发引擎)'
        required: true
        default: 'true'
        type: boolean
      
      enable_shortcut_fe:
        description: 'Shortcut-FE (加速引擎)'
        required: true
        default: 'false'
        type: boolean
      
      enable_fullcone:
        description: 'FullCone-NAT (全锥形NAT)'
        required: true
        default: 'true'
        type: boolean
      
      enable_bbr:
        description: 'BBR (TCP加速)'
        required: true
        default: 'true'
        type: boolean
      
      enable_turboacc:
        description: 'Turbo ACC (网络加速)'
        required: true
        default: 'true'
        type: boolean
      
      # ========== 存储管理 ==========
      enable_diskman:
        description: 'Diskman (磁盘管理)'
        required: true
        default: 'true'
        type: boolean
      
      enable_dockerman:
        description: 'Docker Manager (Docker管理)'
        required: true
        default: 'true'
        type: boolean
      
      enable_filebrowser:
        description: 'FileBrowser (文件浏览器)'
        required: true
        default: 'true'
        type: boolean
      
      enable_qbittorrent:
        description: 'qBittorrent (下载工具)'
        required: true
        default: 'false'
        type: boolean
      
      enable_transmission:
        description: 'Transmission (BT下载)'
        required: true
        default: 'false'
        type: boolean
      
      enable_aria2:
        description: 'Aria2 (下载工具)'
        required: true
        default: 'false'
        type: boolean
      
      # ========== 文件共享 ==========
      enable_samba4:
        description: 'Samba4 (文件共享)'
        required: true
        default: 'true'
        type: boolean
      
      enable_nfs:
        description: 'NFS (网络文件系统)'
        required: true
        default: 'false'
        type: boolean
      
      enable_ftp:
        description: 'FTP Server (FTP服务器)'
        required: true
        default: 'false'
        type: boolean
      
      enable_webdav:
        description: 'WebDAV (文件共享)'
        required: true
        default: 'false'
        type: boolean
      
      # ========== 广告过滤 ==========
      enable_adguardhome:
        description: 'AdGuard Home (广告过滤)'
        required: true
        default: 'true'
        type: boolean
      
      enable_adblock:
        description: 'AdBlock (广告屏蔽)'
        required: true
        default: 'false'
        type: boolean
      
      # ========== 网络工具 ==========
      enable_ddns:
        description: 'DDNS (动态域名)'
        required: true
        default: 'true'
        type: boolean
      
      enable_upnp:
        description: 'UPnP (即插即用)'
        required: true
        default: 'true'
        type: boolean
      
      enable_arpbind:
        description: 'ARP Bind (IP/MAC绑定)'
        required: true
        default: 'true'
        type: boolean
      
      enable_wol:
        description: 'WOL (网络唤醒)'
        required: true
        default: 'true'
        type: boolean
      
      enable_nlbwmon:
        description: 'NLBWMon (流量监控)'
        required: true
        default: 'true'
        type: boolean
      
      enable_vlmcsd:
        description: 'KMS服务器'
        required: true
        default: 'true'
        type: boolean
      
      enable_wireguard:
        description: 'WireGuard (VPN)'
        required: true
        default: 'false'
        type: boolean
      
      enable_openvpn:
        description: 'OpenVPN'
        required: true
        default: 'false'
        type: boolean
      
      enable_zerotier:
        description: 'ZeroTier (内网穿透)'
        required: true
        default: 'false'
        type: boolean
      
      enable_frpc:
        description: 'Frp Client (内网穿透)'
        required: true
        default: 'false'
        type: boolean
      
      enable_frps:
        description: 'Frp Server'
        required: true
        default: 'false'
        type: boolean
      
      # ========== 系统工具 ==========
      enable_autoreboot:
        description: 'Auto Reboot (自动重启)'
        required: true
        default: 'true'
        type: boolean
      
      enable_ttyd:
        description: 'TTYD (网页终端)'
        required: true
        default: 'true'
        type: boolean
      
      enable_cpufreq:
        description: 'CPU Freq (CPU调频)'
        required: true
        default: 'true'
        type: boolean
      
      enable_irqbalance:
        description: 'IRQ Balance (中断负载均衡)'
        required: true
        default: 'true'
        type: boolean
      
      enable_sqm:
        description: 'SQM QoS (流量整形)'
        required: true
        default: 'false'
        type: boolean
      
      enable_netdata:
        description: 'NetData (系统监控)'
        required: true
        default: 'false'
        type: boolean
      
      # ========== 主题 ==========
      enable_argon_theme:
        description: 'Argon主题'
        required: true
        default: 'true'
        type: boolean
      
      enable_design_theme:
        description: 'Design主题'
        required: true
        default: 'false'
        type: boolean
      
      enable_bootstrap_theme:
        description: 'Bootstrap主题'
        required: true
        default: 'false'
        type: boolean
      
      enable_edge_theme:
        description: 'Edge主题'
        required: true
        default: 'false'
        type: boolean
      
      # ========== 网络协议 ==========
      enable_ipv6:
        description: 'IPv6支持'
        required: true
        default: 'true'
        type: boolean
      
      enable_multipath:
        description: '多线多拨'
        required: true
        default: 'false'
        type: boolean
      
      enable_mwan3:
        description: 'MWAN3 (负载均衡)'
        required: true
        default: 'false'
        type: boolean
      
      enable_syncdial:
        description: 'SyncDial (多拨同步)'
        required: true
        default: 'false'
        type: boolean
      
      # ========== USB功能 ==========
      enable_usb_printer:
        description: 'USB打印机支持'
        required: true
        default: 'false'
        type: boolean
      
      enable_usb_4g:
        description: 'USB 4G/5G上网卡'
        required: true
        default: 'false'
        type: boolean
      
      enable_usb_audio:
        description: 'USB音频支持'
        required: true
        default: 'false'
        type: boolean
      
      enable_usb_serial:
        description: 'USB串口支持'
        required: true
        default: 'false'
        type: boolean
      
      # ========== 个性化设置 ==========
      default_ip:
        description: '默认IP地址'
        required: true
        default: '192.168.1.1'
        type: string
      
      default_password:
        description: '默认密码 (留空为password)'
        required: false
        default: ''
        type: string
      
      hostname:
        description: '主机名'
        required: false
        default: 'ImmortalWrt'
        type: string
      
      timezone:
        description: '时区'
        required: true
        default: 'Asia/Shanghai'
        type: choice
        options:
          - Asia/Shanghai
          - Asia/Hong_Kong
          - Asia/Taipei
          - Asia/Tokyo
          - Asia/Singapore
          - America/New_York
          - Europe/London
      
      # ========== 额外软件源 ==========
      add_kenzok8:
        description: '添加kenzok8软件源'
        required: true
        default: 'true'
        type: boolean
      
      add_lienol:
        description: '添加Lienol软件源'
        required: true
        default: 'false'
        type: boolean
      
      add_immortalwrt_packages:
        description: '添加ImmortalWrt官方软件源'
        required: true
        default: 'true'
        type: boolean

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id
    
    steps:
    - name: 检查代码
      uses: actions/checkout@main
    
    - name: 初始化编译环境
      run: |
        sudo -E apt update
        sudo -E apt install -y build-essential asciidoc binutils bzip2 gawk gettext git libncurses5-dev libz-dev patch python3 python2.7 unzip zlib1g-dev lib32gcc-s1 libc6-dev-i386 subversion flex uglifyjs git-core gcc-multilib p7zip p7zip-full msmtp libssl-dev texinfo libglib2.0-dev xmlto qemu-utils upx libelf-dev autoconf automake libtool autopoint device-tree-compiler g++-multilib antlr3 gperf wget curl swig rsync
        sudo -E systemctl daemon-reload
        sudo -E timedatectl set-timezone "${{ github.event.inputs.timezone || 'Asia/Shanghai' }}"
        
    - name: 克隆源码
      run: |
        git clone --depth 1 https://github.com/immortalwrt/immortalwrt -b ${{ github.event.inputs.version }} openwrt
        cd openwrt
        
        if [ "${{ github.event.inputs.add_kenzok8 }}" == "true" ]; then
          echo "src-git kenzo https://github.com/kenzok8/openwrt-packages" >> feeds.conf.default
          echo "src-git small https://github.com/kenzok8/small" >> feeds.conf.default
        fi
        
        if [ "${{ github.event.inputs.add_lienol }}" == "true" ]; then
          echo "src-git lienol https://github.com/Lienol/openwrt-package" >> feeds.conf.default
        fi
        
        if [ "${{ github.event.inputs.add_immortalwrt_packages }}" == "true" ]; then
          echo "src-git immortalwrt https://github.com/immortalwrt/packages.git" >> feeds.conf.default
          echo "src-git luci https://github.com/immortalwrt/luci.git" >> feeds.conf.default
        fi
        
    - name: 更新feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
    - name: 生成配置
      run: |
        cd openwrt
        
        # 基础平台配置
        echo "CONFIG_TARGET_${{ github.event.inputs.target_platform }}=y" >> .config
        
        # ===== Overlay大小设置 =====
        if [ "${{ github.event.inputs.customize_overlay }}" == "true" ]; then
          echo "CONFIG_TARGET_ROOTFS_PARTSIZE=${{ github.event.inputs.rootfs_size }}" >> .config
          
          # 针对x86平台详细设置
          if [[ "${{ github.event.inputs.target_platform }}" == x86_64 ]]; then
            # 设置Overlay类型
            case "${{ github.event.inputs.overlay_type }}" in
              f2fs)
                echo "CONFIG_TARGET_ROOTFS_F2FS=y" >> .config
                # 修改内核配置中的分区大小
                sed -i "s/CONFIG_TARGET_ROOTFS_PARTSIZE=.*/CONFIG_TARGET_ROOTFS_PARTSIZE=${{ github.event.inputs.rootfs_size }}/g" target/linux/x86/image/Makefile
                # 添加Overlay大小配置（部分版本支持）
                echo "CONFIG_TARGET_ROOTFS_OVERLAY_SIZE=${{ github.event.inputs.overlay_size }}" >> .config
                ;;
              ext4)
                echo "CONFIG_TARGET_ROOTFS_EXT4FS=y" >> .config
                sed -i "s/CONFIG_TARGET_ROOTFS_PARTSIZE=.*/CONFIG_TARGET_ROOTFS_PARTSIZE=${{ github.event.inputs.rootfs_size }}/g" target/linux/x86/image/Makefile
                echo "CONFIG_TARGET_ROOTFS_OVERLAY_SIZE=${{ github.event.inputs.overlay_size }}" >> .config
                ;;
              squashfs)
                echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
                # squashfs通常使用剩余空间，无需额外设置
                ;;
            esac
            
            # 扩展内核分区
            if [ "${{ github.event.inputs.expand_kernel }}" == "true" ]; then
              echo "CONFIG_TARGET_KERNEL_PARTSIZE=${{ github.event.inputs.kernel_size }}" >> .config
            fi
          else
            # 非x86平台仅设置根分区大小，overlay由固件自动处理
            echo "注意：非x86平台Overlay大小可能无法直接自定义，将使用默认布局。"
          fi
        fi
        
        # 基础LuCI
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-ssl=y" >> .config
        echo "CONFIG_PACKAGE_luci-compat=y" >> .config
        
        # ========== 科学上网类 ==========
        if [ "${{ github.event.inputs.enable_passwall }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-passwall=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-passwall_Iptables_Transparent_Proxy=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_passwall2 }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-passwall2=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-passwall2_Iptables_Transparent_Proxy=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_openclash }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-openclash=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_ssr_plus }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-ssr-plus=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_V2ray=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Xray=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks_Rust_Client=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_bypass }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-bypass=y" >> .config
        fi
        
        # 代理核心
        if [ "${{ github.event.inputs.enable_v2ray }}" == "true" ]; then
          echo "CONFIG_PACKAGE_v2ray-core=y" >> .config
          echo "CONFIG_PACKAGE_v2ray-plugin=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_xray }}" == "true" ]; then
          echo "CONFIG_PACKAGE_xray-core=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_hysteria }}" == "true" ]; then
          echo "CONFIG_PACKAGE_hysteria=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_tuic }}" == "true" ]; then
          echo "CONFIG_PACKAGE_tuic-client=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_naiveproxy }}" == "true" ]; then
          echo "CONFIG_PACKAGE_naiveproxy=y" >> .config
        fi
        
        # ========== 网络加速 ==========
        if [ "${{ github.event.inputs.enable_sfe }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-flowoffload=y" >> .config
          echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_shortcut_fe }}" == "true" ]; then
          echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_fullcone }}" == "true" ]; then
          echo "CONFIG_PACKAGE_kmod-ipt-fullconenat=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_bbr }}" == "true" ]; then
          echo "CONFIG_PACKAGE_kmod-tcp-bbr=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_turboacc }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
          echo "CONFIG_PACKAGE_turboacc=y" >> .config
        fi
        
        # ========== 存储管理 ==========
        if [ "${{ github.event.inputs.enable_diskman }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-diskman=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-diskman_INCLUDE_badblocks=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-diskman_INCLUDE_mdadm=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_dockerman }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-dockerman=y" >> .config
          echo "CONFIG_PACKAGE_docker-ce=y" >> .config
          echo "CONFIG_PACKAGE_docker-compose=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_filebrowser }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-filebrowser=y" >> .config
          echo "CONFIG_PACKAGE_filebrowser=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_qbittorrent }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-qbittorrent=y" >> .config
          echo "CONFIG_PACKAGE_qbittorrent=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_transmission }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-transmission=y" >> .config
          echo "CONFIG_PACKAGE_transmission-web-control=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_aria2 }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-aria2=y" >> .config
          echo "CONFIG_PACKAGE_aria2=y" >> .config
        fi
        
        # ========== 文件共享 ==========
        if [ "${{ github.event.inputs.enable_samba4 }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-samba4=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_nfs }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-nfs=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_ftp }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-vsftpd=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_webdav }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-webdav=y" >> .config
        fi
        
        # ========== 广告过滤 ==========
        if [ "${{ github.event.inputs.enable_adguardhome }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-adguardhome=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_adblock }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-adblock=y" >> .config
        fi
        
        # ========== 网络工具 ==========
        if [ "${{ github.event.inputs.enable_ddns }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-ddns=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_upnp }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-upnp=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_arpbind }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-arpbind=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_wol }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-wol=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_nlbwmon }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-nlbwmon=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_vlmcsd }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-vlmcsd=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_wireguard }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-wireguard=y" >> .config
          echo "CONFIG_PACKAGE_kmod-wireguard=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_openvpn }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-openvpn=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_zerotier }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-zerotier=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_frpc }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-frpc=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_frps }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-frps=y" >> .config
        fi
        
        # ========== 系统工具 ==========
        if [ "${{ github.event.inputs.enable_autoreboot }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-autoreboot=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_ttyd }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-ttyd=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_cpufreq }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-cpufreq=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_irqbalance }}" == "true" ]; then
          echo "CONFIG_PACKAGE_irqbalance=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_sqm }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-sqm=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_netdata }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-netdata=y" >> .config
        fi
        
        # ========== 主题 ==========
        if [ "${{ github.event.inputs.enable_argon_theme }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-theme-argon=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_design_theme }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-theme-design=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_bootstrap_theme }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-theme-bootstrap=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_edge_theme }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-theme-edge=y" >> .config
        fi
        
        # ========== 网络协议 ==========
        if [ "${{ github.event.inputs.enable_ipv6 }}" == "true" ]; then
          echo "CONFIG_PACKAGE_ipv6helper=y" >> .config
          echo "CONFIG_PACKAGE_odhcp6c=y" >> .config
          echo "CONFIG_PACKAGE_odhcpd-ipv6only=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_multipath }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-syncdial=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_mwan3 }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-mwan3=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_syncdial }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-syncdial=y" >> .config
        fi
        
        # ========== USB功能 ==========
        if [ "${{ github.event.inputs.enable_usb_printer }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-usb-printer=y" >> .config
          echo "CONFIG_PACKAGE_kmod-usb-printer=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_usb_4g }}" == "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-modem=y" >> .config
          echo "CONFIG_PACKAGE_kmod-usb-serial=y" >> .config
          echo "CONFIG_PACKAGE_kmod-usb-serial-option=y" >> .config
          echo "CONFIG_PACKAGE_kmod-usb-serial-wwan=y" >> .config
          echo "CONFIG_PACKAGE_comgt=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_usb_audio }}" == "true" ]; then
          echo "CONFIG_PACKAGE_kmod-usb-audio=y" >> .config
          echo "CONFIG_PACKAGE_alsa-utils=y" >> .config
        fi
        
        if [ "${{ github.event.inputs.enable_usb_serial }}" == "true" ]; then
          echo "CONFIG_PACKAGE_kmod-usb-serial=y" >> .config
          echo "CONFIG_PACKAGE_kmod-usb-serial-ch341=y" >> .config
          echo "CONFIG_PACKAGE_kmod-usb-serial-cp210x=y" >> .config
          echo "CONFIG_PACKAGE_kmod-usb-serial-pl2303=y" >> .config
        fi
        
        # ========== 基础工具 ==========
        echo "CONFIG_PACKAGE_iperf3=y" >> .config
        echo "CONFIG_PACKAGE_htop=y" >> .config
        echo "CONFIG_PACKAGE_nano=y" >> .config
        echo "CONFIG_PACKAGE_curl=y" >> .config
        echo "CONFIG_PACKAGE_wget=y" >> .config
        echo "CONFIG_PACKAGE_tcpdump=y" >> .config
        echo "CONFIG_PACKAGE_openssh-sftp-server=y" >> .config
        echo "CONFIG_PACKAGE_screen=y" >> .config
        echo "CONFIG_PACKAGE_tree=y" >> .config
        echo "CONFIG_PACKAGE_git=y" >> .config
        echo "CONFIG_PACKAGE_unzip=y" >> .config
        echo "CONFIG_PACKAGE_tar=y" >> .config
        
        # 生成完整配置
        make defconfig
        
    - name: 个性化设置
      run: |
        cd openwrt
        
        # 修改默认IP
        sed -i 's/192.168.1.1/${{ github.event.inputs.default_ip }}/g' package/base-files/files/bin/config_generate
        
        # 修改主机名
        if [ -n "${{ github.event.inputs.hostname }}" ]; then
          sed -i "s/hostname='OpenWrt'/hostname='${{ github.event.inputs.hostname }}'/g" package/base-files/files/bin/config_generate
        fi
        
        # 修改默认密码
        if [ -n "${{ github.event.inputs.default_password }}" ]; then
          PWD_HASH=$(openssl passwd -1 "${{ github.event.inputs.default_password }}")
          sed -i "s|root::0:0:99999:7:::|root:${PWD_HASH}:0:0:99999:7:::|g" package/base-files/files/etc/shadow
        fi
        
        # 设置时区
        sed -i "s/timezone='UTC'/timezone='${{ github.event.inputs.timezone }}'/g" package/base-files/files/bin/config_generate
        
        # 添加自定义脚本
        mkdir -p files/etc/uci-defaults
        cat > files/etc/uci-defaults/99-custom << "EOF"
#!/bin/sh
uci set system.@system[0].zonename='${{ github.event.inputs.timezone }}'
uci set system.@system[0].timezone='CST-8'
uci commit system
exit 0
EOF
        chmod +x files/etc/uci-defaults/99-custom
        
    - name: 下载软件包
      run: |
        cd openwrt
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;
        
    - name: 编译固件
      run: |
        cd openwrt
        make -j$(nproc) || make -j1 V=s
        
    - name: 整理固件
      run: |
        cd openwrt
        mkdir -p artifacts
        find bin/targets/ -type f \( -name "*.bin" -o -name "*.img" -o -name "*.gz" -o -name "*.xz" -o -name "*.vmdk" -o -name "*.iso" -o -name "*.manifest" -o -name "sha256sums" \) -exec cp {} artifacts/ \;
        
        # 生成固件信息
        cd artifacts
        {
          echo "=== 固件信息 ==="
          echo "编译时间: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ImmortalWrt版本: ${{ github.event.inputs.version }}"
          echo "目标平台: ${{ github.event.inputs.target_platform }}"
          echo "默认IP: ${{ github.event.inputs.default_ip }}"
          echo "主机名: ${{ github.event.inputs.hostname }}"
          echo "时区: ${{ github.event.inputs.timezone }}"
          echo ""
          echo "=== 包含的主要插件 ==="
          grep -E "CONFIG_PACKAGE_luci-app-.*=y" ../.config | sed 's/CONFIG_PACKAGE_luci-app-//g' | sed 's/=y//g'
        } > firmware_info.txt
        
    - name: 上传固件
      uses: actions/upload-artifact@main
      with:
        name: ImmortalWrt-${{ github.event.inputs.target_platform }}-${{ github.event.inputs.version }}
        path: openwrt/artifacts/
        
    - name: 上传编译日志（失败时）
      if: failure()
      uses: actions/upload-artifact@main
      with:
        name: compile-logs
        path: openwrt/logs/